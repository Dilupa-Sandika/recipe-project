---
// src/pages/recipe/[...slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import sanitizeHtml from 'sanitize-html';
import SocialShare from '../../components/SocialShare.astro'; // <--- IMPORT ADDED

// --- 1. IMAGE PATH HELPER FUNCTION ---
function getPublicImageUrl(recipe: CollectionEntry<'recipes'>, imagePath: string) {
  if (!imagePath) return '';
  const recipeFolder = (() => {
    const fp = recipe.filePath || '';
    if (fp && fp.split) {
      const parts = fp.split(/[/\\]+/);
      const idx = parts.findIndex(p => p === 'recipes');
      if (idx >= 0 && parts.length > idx + 1) return parts[idx + 1];
    }
    return (recipe.slug && recipe.slug.split) ? recipe.slug.split('/')[0] : recipe.slug;
  })();
  if (imagePath.startsWith('./')) {
    return `/content/recipes/${recipeFolder}/${imagePath.slice(2)}`;
  }
  if (imagePath.startsWith('/images/')) {
    const base = imagePath.split('/').pop();
    return `/content/recipes/${recipeFolder}/${base}`;
  }
  return imagePath;
}
// --- END HELPER FUNCTION ---


// Static Paths
export async function getStaticPaths() {
  try {
    const allRecipes = await getCollection('recipes');
    return allRecipes.map(recipe => ({
      params: { slug: recipe.slug },
      props: { recipe },
    }));
  } catch (error) {
    console.error('Error generating recipe paths:', error);
    return [];
  }
}

interface Props {
  recipe: CollectionEntry<'recipes'>;
}

const { recipe } = Astro.props;

// --- IMAGE PATHS ---
const mainImageUrl = getPublicImageUrl(recipe, recipe.data.image);
const mainImageFullUrl = Astro.site ? 
  new URL(mainImageUrl, Astro.site).toString() : mainImageUrl;

let Content;
let seoProps = { 
    title: recipe?.data?.title || 'Recipe Error', 
    description: 'Could not load recipe details.' 
};
let recipeSchema = {};
let mdxComponents = {};

try {
  const renderResult = await recipe.render();
  Content = renderResult.Content;
  
  // For inline step-by-step images
  mdxComponents = {
    img: (props) => Astro.createElement('img', { ...props, src: getPublicImageUrl(recipe, props.src) })
  };

  // --- Sanitize and Extract Schema Data ---
  const body = recipe.body;
  let ingredients: string[] = [];
  const ingredientsMatch = body.match(/##\s+Ingredients\s*\n([\s\S]*?)(?=\n##\s+|$)/);
  if (ingredientsMatch && ingredientsMatch[1]) {
    const ingredientLines = ingredientsMatch[1].match(/^[*\-]\s+(.*)/gm);
    if (ingredientLines) {
      ingredients = ingredientLines.map(line => 
        sanitizeHtml(line.replace(/^[*\-]\s+/, '').trim(), { allowedTags: [], allowedAttributes: {} })
      );
    }
  }

  let instructions: { "@type": string; "text": string }[] = [];
  const instructionsMatch = body.match(/##\s+Instructions\s*\n([\s\S]*?)(?=\n##\s+|$)/);
  if (instructionsMatch && instructionsMatch[1]) {
    const cleanInstructions = instructionsMatch[1].replace(/!\[.*?\]\(.*?\)/g, ''); 
    const instructionLines = cleanInstructions.match(/^\d+\.\s+(.*)/gm);
    if (instructionLines) {
      instructions = instructionLines.map(line => ({
         "@type": "HowToStep",
         "text": sanitizeHtml(line.replace(/^\d+\.\s+/, '').trim(), { allowedTags: [], allowedAttributes: {} })
      }));
    }
  }
  // --- End Sanitize ---

  // Generate Schema.org JSON-LD
  recipeSchema = {
    "@context": "https://schema.org",
    "@type": "Recipe",
    name: recipe.data.title,
    description: recipe.data.description,
    image: mainImageFullUrl,
    prepTime: `PT${recipe.data.prepTime.replace(/\s+/g, '')}`, 
    cookTime: `PT${recipe.data.cookTime.replace(/\s+/g, '')}`, 
    recipeYield: `${recipe.data.servings} servings`,
    datePublished: recipe.data.publishDate.toISOString(),
    recipeCategory: recipe.data.category,
    recipeIngredient: ingredients, 
    recipeInstructions: instructions,
    author: { 
        "@type": "Person",
        name: "Vegas Recipes" 
    }
  };

  // Update seoProps
  seoProps = {
    title: recipe.data.title,
    description: recipe.data.description,
    openGraph: {
      basic: {
        title: recipe.data.title,
        type: 'article',
        image: mainImageUrl,
      }
    },
  };

} catch (error) {
  console.error(`Error rendering recipe "${recipe?.slug}":`, error);
  Content = () => Astro.createElement('p', null, 'Error loading recipe content.');
  seoProps = { title: 'Error', description: 'Could not load recipe' };
}
---

<style>
  /* This style now applies to step-by-step images */
  .recipe-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--color-border);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  .recipe-header { 
    text-align: center;
    border-bottom: 1px solid var(--color-border); 
    padding-bottom: 2rem; 
  }
  .recipe-title { 
    font-size: 2.8rem; 
    font-weight: 900; 
    color: var(--color-text);
    margin-bottom: 1rem; 
    line-height: 1.3; 
  }
  .recipe-meta { 
    display: flex; 
    justify-content: center; 
    gap: 1.5rem; 
    color: var(--color-text-light);
    font-weight: 600;
  }
  .recipe-image { 
    margin-top: 2rem; 
    width: 100%; 
    max-height: 500px; 
    object-fit: cover; 
    border-radius: 12px;
  }
  .recipe-content-wrapper { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 2rem; 
    margin-top: 2rem;
  }
  @media (min-width: 768px) { 
    .recipe-content-wrapper { 
      grid-template-columns: 3fr 1fr;
    } 
  }
  .recipe-content { 
    background: var(--color-white); 
    border: 1px solid var(--color-border); 
    border-radius: 12px;
    padding: 2rem;
    overflow-wrap: break-word; /* Fix for long words */
    word-wrap: break-word;
  }
  .recipe-content h2 { 
    font-size: 1.8rem; 
    font-weight: 700; 
    color: var(--color-primary); 
    margin-top: 2rem; 
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 0.5rem; 
  }
  .recipe-content ul, .recipe-content ol { 
    padding-left: 1.5rem;
    line-height: 1.8; 
    color: var(--color-text);
  }
  .recipe-content li { 
    margin-bottom: 0.85rem;
  }
  .recipe-content li::marker { 
    color: var(--color-primary); 
    font-weight: bold;
  }
  .recipe-content p { 
    line-height: 1.8; 
    font-size: 1rem; 
    margin-bottom: 1rem;
  }
  .recipe-content strong { 
    color: var(--color-text);
  }
  .sidebar { 
    padding-top: 1rem; 
  }
  .affiliate-box { 
    background: var(--color-white);
    border: 1px solid var(--color-border); 
    border-radius: 12px; 
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03); 
    margin-bottom: 1.5rem;
  }
  .affiliate-box h3 { 
    font-size: 1.2rem; 
    font-weight: 700; 
    color: var(--color-text);
    margin-top: 0; 
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--color-border); 
    padding-bottom: 0.5rem; 
  }
  .affiliate-box a { 
    display: block; 
    background-color: var(--color-primary);
    color: var(--color-white); 
    font-weight: 600; 
    text-align: center; 
    padding: 0.85rem; 
    border-radius: 8px; 
    margin-bottom: 0.75rem; 
    transition: background-color 0.2s;
  }
  .affiliate-box a:last-of-type {
    margin-bottom: 0;
  }
  .affiliate-box a:hover { 
    background-color: var(--color-primary-dark); 
    text-decoration: none;
  }
  .card-category { 
    font-size: 0.8rem; 
    font-weight: 700; 
    text-transform: uppercase;
    color: var(--color-primary); 
    display: inline-block; 
    margin-bottom: 0.5rem;
  }
  .card-category:hover { 
    text-decoration: none; 
    color: var(--color-primary-dark);
  }
</style>

<BaseLayout seo={seoProps}>
  <article>
    <header class="recipe-header">
      <a href={`/category/${recipe.data.category.toLowerCase()}`} class="card-category">{recipe.data.category}</a>
      <h1 class="recipe-title">{recipe.data.title}</h1>
      <div class="recipe-meta">
        <span><strong>Prep:</strong> {recipe.data.prepTime}</span>
        <span><strong>Cook:</strong> {recipe.data.cookTime}</span>
        <span><strong>Serves:</strong> {recipe.data.servings}</span>
      </div>
    </header>

    <img
      src={mainImageUrl}
      alt={recipe.data.title}
      class="recipe-image"
    />

    <div class="recipe-content-wrapper">

      <div class="recipe-content">
        <Content components={mdxComponents} />
        
        <SocialShare title={recipe.data.title} description={recipe.data.description} />
      </div>

      <aside class="sidebar">
        {recipe.data.recommendedTools && recipe.data.recommendedTools.length > 0 && (
          <div class="affiliate-box">
            <h3>Recommended Tools</h3>
            {recipe.data.recommendedTools.map(link => (
              <a href={link.url} target="_blank" rel="noopener sponsored">
                {link.label}
              </a>
            ))}
          </div>
        )}
        
        {recipe.data.specialtyIngredients && recipe.data.specialtyIngredients.length > 0 && (
          <div class="affiliate-box">
            <h3>Specialty Ingredients</h3>
            {recipe.data.specialtyIngredients.map(link => (
              <a href={link.url} target="_blank" rel="noopener sponsored">
                {link.label}
              </a>
            ))}
          </div>
        )}
      </aside>

    </div>
  </article>

  <script type="application/ld+json" set:html={JSON.stringify(recipeSchema)} />
</BaseLayout>